<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.fanzip.market.mapper.MarketOrderMapper">
    <!-- 주문 추가 -->
    <insert id="insertOrder" parameterType="map" useGeneratedKeys="true" keyProperty="orderId">
        INSERT INTO orders(user_id, final_amount, status, recipient_name, recipient_phone, shipping_address1, shipping_address2, zipcode, ordered_at)
        VALUES
            (#{userId},
             #{finalAmount},
             #{status},
             #{recipientName},
             #{recipientPhone},
             #{shippingAddress1},
             #{shippingAddress2},
             #{zipcode},
            CURRENT_TIMESTAMP
            )
    </insert>

    <!-- 주문 상세 추가 -->
    <insert id="insertOrderItems" parameterType="map">
        INSERT INTO order_items
        (order_id, cart_item_id, influencer_id, product_id, quantity, unit_price, shipping_price, final_price, created_at)
        VALUES
        <foreach collection="items" item="item" separator=",">
            (#{orderId}, #{item.cartItemId}, #{item.influencerId}, #{item.productId},  #{item.quantity}, #{item.unitPrice}, #{item.shippingPrice}, #{item.finalPrice}, CURRENT_TIMESTAMP)
        </foreach>
    </insert>

    <!-- 주문 상세 조회 -->
    <select id="selectOrderItems" parameterType="long" resultType="org.example.fanzip.market.dto.MarketOrderItemDto">
        SELECT
            cart_item_id as cartItemId,
            product_id as productId,
            influencer_id as influencerId,
            quantity,
            unit_price as unitPrice,
            shipping_price as shippingPrice,
            final_price as finalPrice
        FROM order_items
        WHERE order_id = #{orderId}
    </select>

    <select id="selectCartItemIdsByOrderId" parameterType="long" resultType="long">
        SELECT ci.cart_item_id
        FROM order_items oi JOIN cart_items ci
        ON oi.cart_item_id = ci.cart_item_id
        WHERE oi.order_id = #{orderId}
        AND oi.cart_item_id IS NOT NULL
    </select>

    <delete id="deleteCartItemsByIds" parameterType="list">
        DELETE FROM cart_items
        WHERE cart_item_id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <delete id="deleteCartItemsByUserAndProducts" parameterType="map">
        DELETE ci FROM cart_items ci
        INNER JOIN cart c ON ci.cart_id = c.cart_id
        WHERE c.user_id = #{userId}
        AND ci.product_id IN
        <foreach collection="productIds" item="productId" open="(" close=")" separator=",">
            #{productId}
        </foreach>
    </delete>

    <update id="updateOrderStatus" parameterType="map">
        UPDATE orders SET status=#{status} WHERE order_id=#{orderId}
    </update>

    <!-- 재고차감 -->
    <update id="decreaseProductStock" parameterType="map">
        UPDATE products
        SET stock = stock - #{quantity}
        WHERE product_id = #{productId} AND stock >= #{quantity}
    </update>

    <update id="updateOrderStatusIfCurrent" parameterType="map">
        UPDATE orders
        SET status = #{newStatus}
        WHERE order_id = #{orderId}
          AND status = #{currentStatus}
    </update>

    <select id="selectOrderStatus" parameterType="long" resultType="string">
        SELECT status FROM orders WHERE order_id = #{orderId}
    </select>

    <delete id="deleteOrderItemsByOrderId" parameterType="long">
        DELETE FROM order_items WHERE order_id=#{orderId}
    </delete>

    <delete id="deleteOrderById" parameterType="long">
        DELETE FROM orders WHERE order_id=#{orderId}
    </delete>

    <select id="selectOrderForPayment" parameterType="long" resultType="map">
        SELECT
            order_id AS orderId,
            user_id AS userId,
            final_amount as finalAmount
        FROM orders
        WHERE order_id=#{orderId}
    </select>

    <select id="selectUserIdByOrderId" parameterType="long" resultType="long">
        SELECT user_id FROM orders WHERE order_id = #{orderId}
    </select>

    <!-- 주문 완료 페이지용 주문 상품 조회 (상품 정보 포함) -->
    <select id="selectOrderItemsWithProductDetails" parameterType="long" resultType="org.example.fanzip.market.dto.MarketOrderItemResponseDto">
        SELECT
            oi.product_id as productId,
            oi.influencer_id as influencerId,
            p.name as productName,
            p.thumbnail_image as thumbnailImage,
            oi.quantity,
            oi.unit_price as unitPrice,
            oi.shipping_price as shippingPrice,
            oi.final_price as finalPrice,
            p.price as originalPrice
        FROM order_items oi
        JOIN products p ON oi.product_id = p.product_id
        WHERE oi.order_id = #{orderId}
    </select>

    <!-- 주문 완료 페이지용 주문 상세 정보 조회 -->
    <select id="selectOrderForDetail" parameterType="long" resultType="map">
        SELECT
            order_id AS orderId,
            user_id AS userId,
            final_amount as finalAmount,
            status,
            recipient_name as recipientName,
            recipient_phone as recipientPhone,
            shipping_address1 as shippingAddress1,
            shipping_address2 as shippingAddress2,
            zipcode,
            ordered_at as orderedAt
        FROM orders
        WHERE order_id=#{orderId}
    </select>
</mapper>
