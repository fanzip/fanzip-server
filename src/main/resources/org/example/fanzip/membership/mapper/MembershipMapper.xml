<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.fanzip.membership.mapper.MembershipMapper">

    <resultMap id="membershipMap" type="org.example.fanzip.membership.domain.MembershipVO">
        <id column="membership_id" property="membershipId"/>

        <result column="user_id" property="userId"/>
        <result column="influencer_id" property="influencerId"/>
        <result column="grade_id" property="gradeId"/>
        <result column="status" property="status"/>

        <!-- LocalDate ↔ DATE -->
        <result column="subscription_start" property="subscriptionStart" jdbcType="DATE"/>
        <result column="subscription_end" property="subscriptionEnd" jdbcType="DATE"/>

        <result column="monthly_amount" property="monthlyAmount"/>
        <result column="total_paid_amount" property="totalPaidAmount"/>

        <!-- BOOLEAN ↔ tinyint(1): jdbcType 생략 또는 TINYINT 권장 -->
        <result column="auto_renewal" property="autoRenewal"/>

        <!-- LocalDateTime ↔ TIMESTAMP -->
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- INSERT -->
    <insert id="insertMembership"
            parameterType="org.example.fanzip.membership.domain.MembershipVO"
            useGeneratedKeys="true" keyProperty="membershipId">
        INSERT INTO memberships (
            user_id, influencer_id, grade_id, status,
            subscription_start, subscription_end,
            monthly_amount, total_paid_amount, auto_renewal
        )
        VALUES (
                   #{userId}, #{influencerId}, #{gradeId}, #{status},
                   NOW(), DATE_ADD(NOW(), INTERVAL 1 MONTH),
                   #{monthlyAmount}, #{totalPaidAmount},
                   #{autoRenewal}
               )
    </insert>

    <!-- SELECT by user & influencer -->
    <select id="findByUserIdAndInfluencerId" resultMap="membershipMap">
        SELECT *
        FROM memberships
        WHERE user_id = #{userId} AND influencer_id = #{influencerId}
    </select>

    <!-- 등급/금액 목록 (인플루언서별 가격 X) -->
    <select id="findGradesByInfluencerId"
            resultType="org.example.fanzip.membership.dto.MembershipGradeDTO">
        SELECT
            grade_id            AS gradeId,
            grade_name          AS gradeName,
            benefits_description AS benefitsDescription,
            color               AS color,
            monthly_amount      AS monthlyAmount
        FROM membership_grades
        ORDER BY CASE grade_name
                     WHEN 'VIP' THEN 1
                     WHEN 'GOLD' THEN 2
                     WHEN 'SILVER' THEN 3
                     WHEN 'WHITE' THEN 4
                     ELSE 5
        END

    </select>

    <!-- DELETE -->
    <delete id="deleteByUserIdAndInfluencerId">
        DELETE FROM memberships
        WHERE user_id = #{userId} AND influencer_id = #{influencerId}
    </delete>

    <!-- 사용자가 구독중인 인플루언서 ID 목록 조회 -->
    <select id="findSubscribedInfluencerIdsByUserId" resultType="Long">
        SELECT DISTINCT influencer_id
        FROM memberships
        WHERE user_id = #{userId}
          AND status = 'ACTIVE'
          AND subscription_end >= CURDATE()
    </select>
    
    <!-- 사용자의 최고 등급 조회 -->
    <select id="findHighestGradeByUserId" resultType="String">
        SELECT mg.grade_name
        FROM memberships m
        JOIN membership_grades mg ON m.grade_id = mg.grade_id
        WHERE m.user_id = #{userId}
          AND m.status = 'ACTIVE'
          AND m.subscription_end >= CURDATE()
        ORDER BY CASE mg.grade_name
                     WHEN 'VIP' THEN 1
                     WHEN 'GOLD' THEN 2  
                     WHEN 'SILVER' THEN 3
                     WHEN 'WHITE' THEN 4
                     ELSE 5
                 END
        LIMIT 1
    </select>
    
    <!-- 특정 인플루언서에 대한 사용자의 구독 정보 조회 -->
    <select id="findUserSubscriptionByInfluencerId" resultType="org.example.fanzip.membership.dto.UserMembershipInfoDTO$UserMembershipSubscriptionDTO">
        SELECT 
            m.membership_id AS membershipId,
            m.influencer_id AS influencerId,
            i.influencer_name AS influencerName,
            m.grade_id AS gradeId,
            mg.grade_name AS gradeName,
            mg.color AS gradeColor,
            (m.status = 'ACTIVE' AND m.subscription_end >= CURDATE()) AS isActive
        FROM memberships m
        JOIN influencers i ON m.influencer_id = i.influencer_id
        JOIN membership_grades mg ON m.grade_id = mg.grade_id
        WHERE m.user_id = #{userId} 
          AND m.influencer_id = #{influencerId}
        ORDER BY m.membership_id DESC
        LIMIT 1
    </select>


    <!-- 금액 조회: grade_id → monthly_amount -->
    <select id="findMonthlyAmountByGradeId" parameterType="int" resultType="java.math.BigDecimal">
        SELECT monthly_amount
        FROM membership_grades
        WHERE grade_id = #{gradeId}
        LIMIT 1
    </select>

    <!-- 동시성 잠금: 구독 행을 행잠금 -->
    <select id="findByUserIdAndInfluencerIdForUpdate"
            resultType="org.example.fanzip.membership.domain.MembershipVO">
        SELECT *
        FROM memberships
        WHERE user_id = #{userId}
          AND influencer_id = #{influencerId}
            FOR UPDATE
    </select>

    <!-- 없으면 PENDING 레코드 생성 -->
    <insert id="insertPending">
        INSERT INTO memberships (
            user_id, influencer_id, grade_id, status,
            subscription_start, subscription_end,
            monthly_amount, total_paid_amount, auto_renewal
        ) VALUES (
                     #{userId}, #{influencerId}, #{gradeId}, 'PENDING',
                     NOW(), NULL,
                     #{amount}, 0, false
                 )
    </insert>

    <!-- 있으면 PENDING으로 갱신 -->
    <update id="updateToPending">
        UPDATE memberships
        SET grade_id = #{gradeId},
            status   = 'PENDING',
            monthly_amount = #{amount}
        WHERE user_id = #{userId}
          AND influencer_id = #{influencerId}
    </update>

</mapper>
