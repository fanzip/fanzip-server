<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.fanzip.membership.mapper.MembershipMapper">

    <resultMap id="membershipMap" type="org.example.fanzip.membership.domain.MembershipVO">
        <id column="membership_id" property="membershipId"/>

        <result column="user_id" property="userId"/>
        <result column="influencer_id" property="influencerId"/>
        <result column="grade_id" property="gradeId"/>
        <result column="status" property="status"/>

        <!-- LocalDate ↔ DATE -->
        <result column="subscription_start" property="subscriptionStart" jdbcType="DATE"/>
        <result column="subscription_end" property="subscriptionEnd" jdbcType="DATE"/>

        <result column="monthly_amount" property="monthlyAmount"/>
        <result column="total_paid_amount" property="totalPaidAmount"/>

        <!-- BOOLEAN ↔ tinyint(1): jdbcType 생략 또는 TINYINT 권장 -->
        <result column="auto_renewal" property="autoRenewal"/>

        <!-- LocalDateTime ↔ TIMESTAMP -->
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- INSERT -->
    <insert id="insertMembership"
            parameterType="org.example.fanzip.membership.domain.MembershipVO"
            useGeneratedKeys="true" keyProperty="membershipId">
        INSERT INTO test_db.memberships (
            user_id, influencer_id, grade_id, status,
            subscription_start, subscription_end,
            monthly_amount, total_paid_amount, auto_renewal,
            created_at, updated_at
        )
        VALUES (
                   #{userId}, #{influencerId}, #{gradeId}, #{status},
                   NOW(), DATE_ADD(NOW(), INTERVAL 1 MONTH),
                   #{monthlyAmount}, #{totalPaidAmount},
                   #{autoRenewal},
                   NOW(), NOW()
               )
    </insert>

    <!-- SELECT by user & influencer -->
    <select id="findByUserIdAndInfluencerId" resultMap="membershipMap">
        SELECT *
        FROM test_db.memberships
        WHERE user_id = #{userId} AND influencer_id = #{influencerId}
    </select>

    <!-- 등급/금액 목록 (인플루언서별 가격 X) -->
    <select id="findGradesByInfluencerId"
            resultType="org.example.fanzip.membership.dto.MembershipGradeDTO">
        SELECT
            grade_id            AS gradeId,
            grade_name          AS gradeName,
            benefits_description AS benefitsDescription,
            color               AS color,
            monthly_amount      AS monthlyAmount
        FROM test_db.membership_grades
        ORDER BY CASE grade_name
                     WHEN 'VIP' THEN 1
                     WHEN 'GOLD' THEN 2
                     WHEN 'SILVER' THEN 3
                     WHEN 'WHITE' THEN 4
                     ELSE 5
        END

    </select>

    <!-- DELETE -->
    <delete id="deleteByUserIdAndInfluencerId">
        DELETE FROM test_db.memberships
        WHERE user_id = #{userId} AND influencer_id = #{influencerId}
    </delete>

</mapper>
