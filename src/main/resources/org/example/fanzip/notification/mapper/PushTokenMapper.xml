<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.fanzip.notification.mapper.PushTokenMapper">

    <!-- ① 같은 유저-디바이스 기존 행 제거 -->
    <delete id="deleteByUserAndDevice">
        DELETE FROM user_push_token
        WHERE user_id = #{userId}
          AND device_type = #{deviceType}
    </delete>

    <!-- ② 토큰 기준 upsert (중복 토큰이면 소유자/디바이스 이동) -->
    <insert id="insertOrUpdateByToken">
        INSERT INTO user_push_token (user_id, push_token, device_type, created_at, updated_at)
        VALUES (#{userId}, #{pushToken}, #{deviceType}, NOW(), NOW())
        ON DUPLICATE KEY UPDATE
                             user_id     = VALUES(user_id),
                             device_type = VALUES(device_type),
                             push_token  = VALUES(push_token),
                             updated_at  = NOW()
    </insert>

    <!-- 구독자 토큰 조회 (status = ACTIVE ) -->
    <select id="findTokensByInfluencer" resultType="string">
        SELECT upt.push_token
        FROM memberships m
                 JOIN user_push_token upt ON upt.user_id = m.user_id
        WHERE m.influencer_id = #{influencerId}
          AND m.status = #{status}
    </select>

    <!-- 실패 토큰 일괄 삭제 -->
    <delete id="deleteTokens">
        DELETE FROM user_push_token
        WHERE push_token IN
        <foreach collection="tokens" item="t" open="(" close=")" separator=",">
            #{t}
        </foreach>
    </delete>

    <!-- 특정 사용자의 FCM 토큰 조회 (QR 코드 생성용) -->
    <select id="findTokenByUserId" resultType="string">
        SELECT push_token
        FROM user_push_token
        WHERE user_id = #{userId}
        ORDER BY updated_at DESC
        LIMIT 1
    </select>

</mapper>
